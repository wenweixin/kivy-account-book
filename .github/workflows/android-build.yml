# .github/workflows/android-build.yml
name: å®‰å“APKè‡ªåŠ¨æ‰“åŒ…

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–+å¼ºåˆ¶é…ç½®Java 17ä¸ºé»˜è®¤ç‰ˆæœ¬ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–å¹¶é…ç½®Java 17
        run: |
          sudo apt update -y
          # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå«openjdk-17-jdkï¼‰
          sudo apt install -y \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            python3-dev \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            libsqlite3-dev \
            build-essential \
            liblzma-dev \
            libbz2-dev \
            libreadline-dev \
            expect \
            lib32z1-dev \
            lib32stdc++6
          
          # å¼ºåˆ¶å°†Java 17è®¾ä¸ºç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬
          sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-17-openjdk-amd64/bin/java 1
          sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac 1
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
          
          # éªŒè¯Javaç‰ˆæœ¬ï¼ˆå¿…é¡»æ˜¾ç¤º17.x.xï¼‰
          java -version
          javac -version
          
          # é…ç½®JAVA_HOMEç¯å¢ƒå˜é‡ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH" >> $GITHUB_ENV

      # æ­¥éª¤3ï¼šå‡çº§pipå¹¶å®‰è£…æ ¸å¿ƒPythonä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install --upgrade buildozer
          pip3 install --upgrade cython==0.29.33
          pip3 install git+https://github.com/kivy/python-for-android.git@master

      # æ­¥éª¤4ï¼šå®Œæ•´é…ç½®Buildozerä¸“å±SDKï¼ˆé€‚é…Java 17ï¼‰
      - name: é…ç½®å®Œæ•´Android SDKç¯å¢ƒ
        run: |
          # åŠ è½½Java 17ç¯å¢ƒå˜é‡
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          
          # Buildozeré»˜è®¤SDKæ ¹è·¯å¾„
          BUILDOZER_SDK_PATH="/home/runner/.buildozer/android/platform/android-sdk"
          mkdir -p $BUILDOZER_SDK_PATH
          
          # 1. å®‰è£…SDK Command-line Toolsï¼ˆé€‚é…æ–°ç‰ˆç›®å½•ç»“æ„ï¼‰
          CMDLINE_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          wget --no-check-certificate $CMDLINE_TOOLS_URL -O cmdline-tools.zip
          
          # åˆ›å»ºä¸´æ—¶è§£å‹ç›®å½•
          mkdir -p tmp_cmdline_tools
          unzip -q -o cmdline-tools.zip -d tmp_cmdline_tools/
          
          # æ–°ç‰ˆCommand-line Toolsè§£å‹åæ ¹ç›®å½•æ˜¯cmdline-toolsï¼Œéœ€ç§»åŠ¨åˆ°latest
          mkdir -p $BUILDOZER_SDK_PATH/cmdline-tools/latest
          # ç§»åŠ¨è§£å‹åçš„æ‰€æœ‰æ–‡ä»¶åˆ°latestç›®å½•ï¼ˆé€‚é…ä¸åŒè§£å‹ç»“æ„ï¼‰
          cp -r tmp_cmdline_tools/*/* $BUILDOZER_SDK_PATH/cmdline-tools/latest/ || cp -r tmp_cmdline_tools/* $BUILDOZER_SDK_PATH/cmdline-tools/latest/
          rm -rf tmp_cmdline_tools cmdline-tools.zip
          
          # 2. å†™å…¥SDKè®¸å¯è¯ï¼ˆè·³è¿‡äº¤äº’ï¼‰
          mkdir -p $BUILDOZER_SDK_PATH/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $BUILDOZER_SDK_PATH/licenses/android-sdk-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $BUILDOZER_SDK_PATH/licenses/android-sdk-preview-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $BUILDOZER_SDK_PATH/licenses/androidsdk-license
          
          # 3. é…ç½®ç¯å¢ƒå˜é‡ï¼Œè®©sdkmanagerç”Ÿæ•ˆï¼ˆç»‘å®šJava 17ï¼‰
          export ANDROID_HOME=$BUILDOZER_SDK_PATH
          export ANDROID_SDK_ROOT=$BUILDOZER_SDK_PATH
          export PATH=$BUILDOZER_SDK_PATH/cmdline-tools/latest/bin:$PATH
          
          # éªŒè¯sdkmanageræ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ï¼ˆJava 17ç¯å¢ƒï¼‰
          echo "ğŸ” éªŒè¯sdkmanagerç‰ˆæœ¬ï¼ˆJava 17ç¯å¢ƒï¼‰ï¼š"
          sdkmanager --version || (echo "âŒ sdkmanagerå¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥Javaç‰ˆæœ¬" && exit 1)
          
          # 4. å®‰è£…SDK Platform Toolsï¼ˆBuildozerå¿…éœ€ï¼‰
          sdkmanager --sdk_root=$BUILDOZER_SDK_PATH "platform-tools" --verbose
          
          # 5. å®‰è£…Build-Tools 33.0.2ï¼ˆBuildozeræŒ‡å®šç‰ˆæœ¬ï¼‰
          sdkmanager --sdk_root=$BUILDOZER_SDK_PATH "build-tools;33.0.2" --verbose
          
          # 6. å®‰è£…Android 33 SDK Platformï¼ˆå¯é€‰ä½†å»ºè®®ï¼‰
          sdkmanager --sdk_root=$BUILDOZER_SDK_PATH "platforms;android-33" --verbose
          
          # 7. ç¡®è®¤aidlå¯ç”¨
          AIDL_PATH=$BUILDOZER_SDK_PATH/build-tools/33.0.2/aidl
          if [ -f "$AIDL_PATH" ]; then
            echo "âœ… Aidlå·¥å…·å·²æ‰¾åˆ°ï¼š$AIDL_PATH"
          else
            echo "âŒ Aidlå·¥å…·ç¼ºå¤±ï¼ŒBuild-Toolsç›®å½•ï¼š"
            ls -la $BUILDOZER_SDK_PATH/build-tools/
            exit 1
          fi
          
          # èµ‹äºˆå…¨æƒé™
          chmod -R 777 /home/runner/.buildozer

      # æ­¥éª¤5ï¼šåˆå§‹åŒ–å¹¶é…ç½®Buildozer.specï¼ˆå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬ï¼‰
      - name: åˆå§‹åŒ–å¹¶é…ç½®Buildozer.spec
        run: |
          buildozer init
          
          # æ‰¹é‡ä¿®æ”¹é…ç½®
          sed -i 's|title = My Application|title = è®°è´¦æœ¬|' buildozer.spec
          sed -i 's|package.name = myapp|package.name = accountbook|' buildozer.spec
          sed -i 's|package.domain = org.test|package.domain = org.example|' buildozer.spec
          sed -i 's|source.include_exts = py,png,jpg,kv,atlas|source.include_exts = py,png,jpg,kv,atlas,ttf|' buildozer.spec
          sed -i 's|# source.include_files = |source.include_files = simhei.ttf|' buildozer.spec
          sed -i 's|requirements = python3,kivy|requirements = python3,kivy==2.3.0|' buildozer.spec
          
          # å¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬
          sed -i 's|# android.build_tools = 33.0.0|android.build_tools = 33.0.2|' buildozer.spec
          sed -i 's|android.ndk = 25b|android.ndk = 25b|' buildozer.spec
          sed -i 's|android.api = 27|android.api = 33|' buildozer.spec
          sed -i 's|android.ndk_api = 21|android.ndk_api = 25|' buildozer.spec
          sed -i 's|android.arch = armeabi-v7a|android.arch = arm64-v8a|' buildozer.spec
          sed -i 's|# android.permissions = |android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE|' buildozer.spec
          sed -i 's|android.logcat = false|android.logcat = false|' buildozer.spec
          sed -i 's|# android.sdk_path = |android.sdk_path = /home/runner/.buildozer/android/platform/android-sdk|' buildozer.spec

      # æ­¥éª¤6ï¼šæ„å»ºå®‰å“APK
      - name: æ„å»ºå®‰å“APK
        run: |
          # é…ç½®ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿æ‰€æœ‰å·¥å…·è·¯å¾„ç”Ÿæ•ˆï¼ˆç»‘å®šJava 17ï¼‰
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ANDROIDNDK="/home/runner/.buildozer/android/platform/android-ndk-r25b"
          export ANDROIDAPI="33"
          export ANDROID_BUILD_TOOLS="33.0.2"
          export PATH=$JAVA_HOME/bin:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/33.0.2:$PATH
          
          # éªŒè¯Javaå’Œsdkmanagerç‰ˆæœ¬
          java -version
          sdkmanager --version
          
          # æ„å»ºAPK
          buildozer android debug

      # æ­¥éª¤7ï¼šä¸Šä¼ APKäº§ç‰©
      - name: ä¸Šä¼ APKäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: è®°è´¦æœ¬-å®‰å“APK
          path: |
            ${{ github.workspace }}/bin/accountbook-0.1-debug.apk
            ${{ github.workspace }}/.buildozer/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 90
