# .github/workflows/android-build.yml
name: å®‰å“APKè‡ªåŠ¨æ‰“åŒ…

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            python3-dev \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            libsqlite3-dev \
            build-essential \
            liblzma-dev \
            libbz2-dev \
            libreadline-dev \
            expect \
            lib32z1-dev \
            lib32stdc++6

      # æ­¥éª¤3ï¼šå‡çº§pipå¹¶å®‰è£…æ ¸å¿ƒPythonä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install --upgrade buildozer
          pip3 install --upgrade cython==0.29.33
          pip3 install git+https://github.com/kivy/python-for-android.git@master

      # æ­¥éª¤4ï¼šç¼“å­˜Buildozerä¾èµ–
      - name: ç¼“å­˜Buildozerä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.buildozer
            ${{ github.workspace }}/.buildozer
            ~/.local/share/python-for-android
            ~/Android/Sdk
          key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # æ­¥éª¤5ï¼šé…ç½®å®‰å“SDKè®¸å¯è¯
      - name: é…ç½®å®‰å“SDKè®¸å¯è¯
        run: |
          mkdir -p ~/Android/Sdk/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/Android/Sdk/licenses/android-sdk-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > ~/Android/Sdk/licenses/android-sdk-preview-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/Android/Sdk/licenses/androidsdk-license
          export ANDROID_HOME=~/Android/Sdk
          export PATH=$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$PATH

      # æ­¥éª¤6ï¼šåˆå§‹åŒ–å¹¶é…ç½®Buildozer.spec
      - name: åˆå§‹åŒ–å¹¶é…ç½®Buildozer.spec
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          buildozer init
          if [ ! -d ".buildozer" ]; then
            echo "æ‰‹åŠ¨åˆ›å»º.buildozerç›®å½•"
            mkdir -p .buildozer/android/platform/python-for-android
            mkdir -p .buildozer/android/app
            mkdir -p .buildozer/applibs
            mkdir -p bin
          fi
          
          # æ‰¹é‡ä¿®æ”¹é…ç½®
          sed -i 's|title = My Application|title = è®°è´¦æœ¬|' buildozer.spec
          sed -i 's|package.name = myapp|package.name = accountbook|' buildozer.spec
          sed -i 's|package.domain = org.test|package.domain = org.example|' buildozer.spec
          sed -i 's|source.include_exts = py,png,jpg,kv,atlas|source.include_exts = py,png,jpg,kv,atlas,ttf|' buildozer.spec
          sed -i 's|# source.include_files = |source.include_files = simhei.ttf|' buildozer.spec
          sed -i 's|requirements = python3,kivy|requirements = python3,kivy==2.3.0|' buildozer.spec
          sed -i 's|# android.build_tools = 33.0.0|android.build_tools = 33.0.2|' buildozer.spec
          sed -i 's|android.ndk = 25b|android.ndk = 25b|' buildozer.spec
          sed -i 's|android.api = 27|android.api = 33|' buildozer.spec
          sed -i 's|android.ndk_api = 21|android.ndk_api = 25|' buildozer.spec
          sed -i 's|android.arch = armeabi-v7a|android.arch = arm64-v8a|' buildozer.spec
          sed -i 's|# android.permissions = |android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE|' buildozer.spec
          sed -i 's|android.logcat = false|android.logcat = false|' buildozer.spec
          sed -i 's|# android.sdk_path = |android.sdk_path = ~/Android/Sdk|' buildozer.spec

      # æ­¥éª¤7ï¼šä¿®å¤ç›®å½•æƒé™
      - name: ä¿®å¤ç›®å½•æƒé™
        run: |
          if [ ! -d "/home/runner/.buildozer" ]; then
            mkdir -p /home/runner/.buildozer/android/platform/python-for-android
          fi
          chmod -R 777 /home/runner/.buildozer
          chmod -R 777 ${{ github.workspace }}/.buildozer
          chmod -R 777 ${{ github.workspace }}/bin
          chmod -R 777 ~/Android/Sdk

      # æ­¥éª¤8ï¼šæ‰‹åŠ¨å®‰è£…Build-Tools 33.0.2ï¼ˆä¿®æ­£ä¸‹è½½åœ°å€+å¼ºåŒ–æ ¡éªŒï¼‰
      - name: æ‰‹åŠ¨å®‰è£…Build-Tools 33.0.2
        run: |
          export ANDROID_HOME=~/Android/Sdk
          # åˆ›å»ºBuild-Toolsç›®å½•ï¼ˆç¡®ä¿å­˜åœ¨ï¼‰
          mkdir -p $ANDROID_HOME/build-tools
          
          # æ ¸å¿ƒä¿®æ­£ï¼šæ¢å¤å¸¦rçš„æ­£ç¡®ä¸‹è½½åœ°å€ï¼ˆä¼˜å…ˆæ¸…åé•œåƒï¼‰
          BUILD_TOOLS_URL="https://mirrors.tuna.tsinghua.edu.cn/android/repository/build-tools_r33.0.2-linux.zip"
          BACKUP_URL="https://dl.google.com/android/repository/build-tools_r33.0.2-linux.zip"
          
          # ä¸‹è½½å¹¶æ ¡éªŒæ–‡ä»¶ï¼ˆç¡®ä¿ä¸‹è½½æˆåŠŸï¼‰
          echo "ğŸ“¥ ä»æ¸…åé•œåƒä¸‹è½½Build-Tools 33.0.2..."
          wget --no-check-certificate $BUILD_TOOLS_URL -O build-tools.zip || (echo "âŒ æ¸…åé•œåƒä¸‹è½½å¤±è´¥ï¼Œå°è¯•è°·æ­Œå®˜æ–¹åœ°å€..." && wget --no-check-certificate $BACKUP_URL -O build-tools.zip)
          
          # æ ¡éªŒä¸‹è½½çš„æ–‡ä»¶å¤§å°ï¼ˆé¿å…ç©ºæ–‡ä»¶ï¼‰
          FILE_SIZE=$(stat -c%s "build-tools.zip" 2>/dev/null || echo 0)
          if [ $FILE_SIZE -lt 1000000 ]; then # å°äº1MBåˆ™åˆ¤å®šä¸ºä¸‹è½½å¤±è´¥
            echo "âŒ Build-ToolsåŒ…ä¸‹è½½å¤±è´¥ï¼Œæ–‡ä»¶å¤§å°ï¼š$FILE_SIZE å­—èŠ‚"
            ls -la build-tools.zip
            exit 1
          fi
          echo "âœ… Build-ToolsåŒ…ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$((FILE_SIZE/1024/1024)) MB"
          
          # è§£å‹åˆ°Build-Toolsç›®å½•ï¼ˆè¦†ç›–å·²æœ‰æ–‡ä»¶ï¼‰
          unzip -q -o build-tools.zip -d $ANDROID_HOME/build-tools/
          
          # æŸ¥çœ‹è§£å‹åçš„å®é™…ç›®å½•åï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "ğŸ“‚ è§£å‹åçš„Build-Toolsç›®å½•åˆ—è¡¨ï¼š"
          ls -la $ANDROID_HOME/build-tools/
          
          # é€‚é…ä¸¤ç§ç›®å½•åï¼šä¼˜å…ˆandroid-13ï¼Œå†åŒ¹é…33.0.2å¼€å¤´
          if [ -d "$ANDROID_HOME/build-tools/android-13" ]; then
            BUILD_TOOLS_DIR="android-13"
            echo "âœ… æ‰¾åˆ°android-13ç›®å½•ï¼ˆå¯¹åº”Build-Tools 33.0.2ï¼‰"
          else
            BUILD_TOOLS_DIR=$(ls $ANDROID_HOME/build-tools/ | grep "^33.0.2" | head -n1)
          fi
          
          # æ ¡éªŒç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -z "$BUILD_TOOLS_DIR" ] || [ ! -d "$ANDROID_HOME/build-tools/$BUILD_TOOLS_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°Build-Tools 33.0.2ç›¸å…³ç›®å½•ï¼Œå½“å‰ç›®å½•ï¼š"
            ls -la $ANDROID_HOME/build-tools/
            exit 1
          fi
          
          # é‡å‘½åä¸ºBuildozerè¯†åˆ«çš„33.0.2-linux
          mv $ANDROID_HOME/build-tools/$BUILD_TOOLS_DIR $ANDROID_HOME/build-tools/33.0.2-linux
          
          # ç¡®è®¤Aidlå·¥å…·å­˜åœ¨
          AIDL_PATH=$ANDROID_HOME/build-tools/33.0.2-linux/aidl
          if [ -f "$AIDL_PATH" ]; then
            echo "âœ… Aidlå·¥å…·å·²æ‰¾åˆ°ï¼š$AIDL_PATH"
          else
            echo "âŒ Aidlå·¥å…·ç¼ºå¤±ï¼Œ33.0.2-linuxç›®å½•å†…å®¹ï¼š"
            ls -la $ANDROID_HOME/build-tools/33.0.2-linux/
            exit 1
          fi

      # æ­¥éª¤9ï¼šæ„å»ºå®‰å“APK
      - name: æ„å»ºå®‰å“APK
        run: |
          export ANDROID_HOME=~/Android/Sdk
          export PATH=$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/33.0.2-linux:$PATH
          echo "PATH: $PATH"
          which aidl || echo "âš ï¸ aidlä¸åœ¨PATHä¸­ï¼Œä½†å·²ç¡®è®¤æ–‡ä»¶å­˜åœ¨"
          buildozer android debug

      # æ­¥éª¤10ï¼šä¸Šä¼ APKäº§ç‰©
      - name: ä¸Šä¼ APKåˆ°GitHubäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: è®°è´¦æœ¬-å®‰å“APK
          path: |
            ${{ github.workspace }}/bin/accountbook-0.1-debug.apk
            ${{ github.workspace }}/.buildozer/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 90
