# .github/workflows/android-build.yml
name: 安卓APK自动打包

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android-apk:
    runs-on: ubuntu-22.04
    steps:
      # 步骤1：拉取仓库代码
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤2：安装系统依赖（完整版本，包含python-for-android所需依赖）
      - name: 安装系统依赖
        run: |
          sudo apt update -y
          sudo apt install -y \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            python3-dev \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            libsqlite3-dev \
            build-essential \
            liblzma-dev \
            libbz2-dev \
            libreadline-dev

      # 步骤3：升级pip并安装核心Python依赖（手动安装python-for-android）
      - name: 安装Python依赖
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install --upgrade buildozer
          pip3 install --upgrade cython==0.29.33
          # 手动安装python-for-android（关键！解决目录缺失问题）
          pip3 install git+https://github.com/kivy/python-for-android.git@master

      # 步骤4：缓存Buildozer依赖（加速SDK/NDK下载）
      - name: 缓存Buildozer依赖
        uses: actions/cache@v3
        with:
          path: |
            ~/.buildozer
            ./.buildozer
            ~/.local/share/python-for-android
          key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # 步骤5：初始化Buildozer并配置（先初始化，再修改配置）
      - name: 初始化并配置Buildozer.spec
        run: |
          # 先初始化buildozer.spec（确保目录结构创建）
          buildozer init
          
          # 批量修改配置（适配你的代码）
          sed -i 's/title = My Application/title = 记账本/' buildozer.spec
          sed -i 's/package.name = myapp/package.name = accountbook/' buildozer.spec
          sed -i 's/package.domain = org.test/package.domain = org.example/' buildozer.spec
          sed -i 's/source.include_exts = py,png,jpg,kv,atlas/source.include_exts = py,png,jpg,kv,atlas,ttf/' buildozer.spec
          sed -i 's/# source.include_files = /source.include_files = simhei.ttf/' buildozer.spec
          # 匹配你的代码中kivy.require('2.3.0')
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy==2.3.0/' buildozer.spec
          # 修正NDK API版本（适配python-for-android）
          sed -i 's/android.ndk = 25b/android.ndk = 25b/' buildozer.spec
          sed -i 's/android.api = 33/android.api = 33/' buildozer.spec
          sed -i 's/android.ndk_api = 21/android.ndk_api = 25/' buildozer.spec
          sed -i 's/android.arch = armeabi-v7a/android.arch = arm64-v8a/' buildozer.spec
          sed -i 's/# android.permissions = /android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE/' buildozer.spec
          sed -i 's/android.logcat = false/android.logcat = false/' buildozer.spec
          # 强制指定python-for-android路径（避免找不到）
          sed -i 's/# p4a.source_dir = /p4a.source_dir = ~/.local/lib/python3.10/site-packages/pythonforandroid/' buildozer.spec

      # 步骤6：修复目录权限（避免权限不足）
      - name: 修复目录权限
        run: |
          mkdir -p /home/runner/.buildozer/android/platform/python-for-android
          chmod -R 777 /home/runner/.buildozer
          chmod -R 777 ./.buildozer

      # 步骤7：构建安卓APK（跳过clean，先build避免目录缺失）
      - name: 构建安卓APK
        run: |
          # 先直接build，而非clean（首次构建clean会触发目录缺失错误）
          buildozer android debug

      # 步骤8：上传APK产物
      - name: 上传APK到GitHub产物
        uses: actions/upload-artifact@v4
        with:
          name: 记账本-安卓APK
          path: bin/accountbook-0.1-debug.apk
          retention-days: 90
