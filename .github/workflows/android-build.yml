# .github/workflows/android-build.yml
# 工作流名称
name: 安卓APK自动打包

# 触发条件：当代码推送到main分支，或创建Pull Request时触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 运行的作业
jobs:
  build-android-apk:
    # 运行环境：Ubuntu 22.04（Buildozer最佳兼容环境）
    runs-on: ubuntu-22.04
    
    # 作业步骤
    steps:
      # 步骤1：拉取GitHub仓库代码到云端环境
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤2：安装系统依赖（Buildozer需要的Linux库）
      - name: 安装系统依赖
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev

      # 步骤3：安装Python依赖（Buildozer、Kivy）
      - name: 安装Python依赖
        run: |
          python3 -m pip install --upgrade pip
          pip3 install --upgrade buildozer
          pip3 install --upgrade cython==0.29.33  # 适配Buildozer的Cython版本

      # 步骤4：生成Buildozer配置文件并修改（自动适配云端环境）
      - name: 配置Buildozer.spec
        run: |
          # 生成基础配置文件
          buildozer init
          
          # 批量修改配置（替换默认值，无需手动改）
          # 应用名称
          sed -i 's/title = My Application/title = 记账本/' buildozer.spec
          # 包名（小写，无空格）
          sed -i 's/package.name = myapp/package.name = accountbook/' buildozer.spec
          # 域名（随便填）
          sed -i 's/package.domain = org.test/package.domain = org.example/' buildozer.spec
          # 包含的文件类型（必须加ttf字体）
          sed -i 's/source.include_exts = py,png,jpg,kv,atlas/source.include_exts = py,png,jpg,kv,atlas,ttf/' buildozer.spec
          # 打包字体文件（关键！）
          sed -i 's/# source.include_files = /source.include_files = simhei.ttf/' buildozer.spec
          # 指定Kivy版本（和代码适配的版本一致）
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy==2.3.1/' buildozer.spec
          # 安卓API等级（适配大多数手机）
          sed -i 's/android.api = 27/android.api = 33/' buildozer.spec
          # NDK版本（兼容版本）
          sed -i 's/android.ndk = 25b/android.ndk = 25b/' buildozer.spec
          # 安卓架构（64位，主流手机）
          sed -i 's/android.arch = armeabi-v7a/android.arch = arm64-v8a/' buildozer.spec
          # 申请存储权限（安卓保存数据需要）
          sed -i 's/# android.permissions = /android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE/' buildozer.spec
          # 关闭安卓日志（减少输出）
          sed -i 's/android.logcat = false/android.logcat = false/' buildozer.spec

      # 步骤5：开始打包APK（首次打包会下载SDK/NDK，耗时20-40分钟）
      - name: 构建安卓APK
        run: |
          # 清理旧缓存
          buildozer android clean
          # 打包debug版APK（可直接安装）
          buildozer android debug

      # 步骤6：上传APK作为构建产物（方便下载）
      - name: 上传APK到GitHub产物
        uses: actions/upload-artifact@v4
        with:
          # 产物名称（自定义）
          name: 记账本-安卓APK
          # APK文件路径（Buildozer打包后默认生成在bin目录）
          path: bin/accountbook-0.1-debug.apk
          # 产物保留时间（默认90天，可选）
          retention-days: 90
