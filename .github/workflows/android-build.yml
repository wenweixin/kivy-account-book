# .github/workflows/android-build.yml
name: 安卓APK自动打包

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android-apk:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    timeout-minutes: 90
    env:
      BUILDOZER_LOG_LEVEL: 2
      ANDROIDNDK: /home/runner/.buildozer/android/platform/android-ndk-r21e
      ANDROIDSDK: /home/runner/.buildozer/android/platform/android-sdk
      ANDROIDAPI: 21
      ANDROID_BUILD_TOOLS: 30.0.3
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      ANDROID_NDK_ROOT: /home/runner/.buildozer/android/platform/android-ndk-r21e
      JAVA_OPTS: "-Xmx4096m -Xms2048m"
      GRADLE_OPTS: "-Xmx4096m -Xms2048m"

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装系统依赖并配置Java 17
        run: |
          sudo apt update -y
          sudo apt install -y git zip unzip openjdk-17-jdk python3-pip python3-dev autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev libsqlite3-dev build-essential liblzma-dev libbz2-dev libreadline-dev expect lib32z1-dev lib32stdc++6 libjpeg-dev libltdl-dev
          
          sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-17-openjdk-amd64/bin/java 1
          sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac 1
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
          
          java -version
          javac -version
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH" >> $GITHUB_ENV

      - name: 安装Python依赖（关键：降级Cython到兼容版本）
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip install --upgrade pip
          # 降级Cython到0.29.36（与Kivy 2.1.0完全兼容）
          pip3 install --upgrade buildozer cython==0.29.36 kivy==2.1.0
          pip3 install git+https://github.com/kivy/python-for-android.git@master
          pip3 install pyjnius==1.6.1 plyer==2.1.0

      - name: 检查代码语法和资源文件
        run: |
          echo "✅ 检查Python代码语法..."
          python3 -m py_compile account_book.py || (echo "❌ account_book.py语法错误" && exit 1)
          
          echo "✅ 检查资源文件..."
          if [ ! -f "simhei.ttf" ]; then
            echo "⚠️ simhei.ttf文件缺失，将注释该配置"
            SIMHEI_MISSING=1
          else
            SIMHEI_MISSING=0
          fi
          echo "SIMHEI_MISSING=$SIMHEI_MISSING" >> $GITHUB_ENV

      - name: 配置Android SDK/NDK环境
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          
          BUILDOZER_SDK_PATH="/home/runner/.buildozer/android/platform/android-sdk"
          BUILDOZER_NDK_PATH="/home/runner/.buildozer/android/platform/android-ndk-r21e"
          mkdir -p $BUILDOZER_SDK_PATH $BUILDOZER_NDK_PATH
          
          CMDLINE_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          wget --no-check-certificate $CMDLINE_TOOLS_URL -O cmdline-tools.zip
          mkdir -p tmp_cmdline_tools
          unzip -q -o cmdline-tools.zip -d tmp_cmdline_tools/
          mkdir -p $BUILDOZER_SDK_PATH/cmdline-tools/latest
          cp -r tmp_cmdline_tools/*/* $BUILDOZER_SDK_PATH/cmdline-tools/latest/ || cp -r tmp_cmdline_tools/* $BUILDOZER_SDK_PATH/cmdline-tools/latest/
          rm -rf tmp_cmdline_tools cmdline-tools.zip
          
          mkdir -p $BUILDOZER_SDK_PATH/tools/bin
          ln -s $BUILDOZER_SDK_PATH/cmdline-tools/latest/bin/sdkmanager $BUILDOZER_SDK_PATH/tools/bin/sdkmanager
          ln -s $BUILDOZER_SDK_PATH/cmdline-tools/latest/bin/avdmanager $BUILDOZER_SDK_PATH/tools/bin/avdmanager
          
          export ANDROID_HOME=$BUILDOZER_SDK_PATH
          export ANDROID_SDK_ROOT=$BUILDOZER_SDK_PATH
          export PATH=$BUILDOZER_SDK_PATH/cmdline-tools/latest/bin:$BUILDOZER_SDK_PATH/tools/bin:$PATH
          
          echo y | sdkmanager --sdk_root=$BUILDOZER_SDK_PATH --licenses || true
          echo y | sdkmanager --sdk_root=$BUILDOZER_SDK_PATH "platform-tools" "build-tools;30.0.3" "platforms;android-21" --verbose
          
          echo "✅ 安装NDK r21e..."
          NDK_URL="https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip"
          wget --no-check-certificate $NDK_URL -O android-ndk-r21e.zip
          unzip -q -o android-ndk-r21e.zip -d /home/runner/.buildozer/android/platform/
          rm -f android-ndk-r21e.zip
          
          if [ ! -d "$BUILDOZER_NDK_PATH" ]; then
            echo "❌ NDK r21e安装失败"
            ls -la /home/runner/.buildozer/android/platform/
            exit 1
          fi
          echo "✅ NDK r21e安装成功：$BUILDOZER_NDK_PATH"
          
          AIDL_PATH=$BUILDOZER_SDK_PATH/build-tools/30.0.3/aidl
          if [ -f "$AIDL_PATH" ]; then
            echo "✅ Aidl工具已找到：$AIDL_PATH"
          else
            echo "❌ Aidl工具缺失"
            exit 1
          fi
          
          chmod -R 777 /home/runner/.buildozer

      - name: 配置Buildozer.spec（针对Android 13存储权限）
        run: |
          buildozer init
          
          sed -i 's|title = My Application|title = 记账本|' buildozer.spec
          sed -i 's|package.name = myapp|package.name = accountbook|' buildozer.spec
          sed -i 's|package.domain = org.test|package.domain = org.example|' buildozer.spec
          sed -i 's|source.include_exts = py,png,jpg,kv,atlas|source.include_exts = py,png,jpg,kv,atlas,ttf|' buildozer.spec
          
          # 处理字体文件缺失
          if [ $SIMHEI_MISSING -eq 1 ]; then
            sed -i 's|source.include_files = simhei.ttf|# source.include_files = simhei.ttf|' buildozer.spec
          else
            sed -i 's|# source.include_files = |source.include_files = simhei.ttf|' buildozer.spec
          fi
          
          # 依赖配置（匹配安装的版本）
          sed -i 's|requirements = python3,kivy|requirements = python3,kivy==2.1.0,pyjnius==1.6.1,plyer==2.1.0|' buildozer.spec
          
          # Android配置
          sed -i 's|# android.build_tools = 33.0.0|android.build_tools = 30.0.3|' buildozer.spec
          sed -i 's|android.ndk = 25b|android.ndk = 21e|' buildozer.spec
          sed -i 's|android.api = 27|android.api = 21|' buildozer.spec
          sed -i 's|android.ndk_api = 21|android.ndk_api = 21|' buildozer.spec
          sed -i 's|android.arch = arm64-v8a|android.arch = armeabi-v7a|' buildozer.spec
          
          # 针对Android 13的权限配置 - 包含新权限模型
          sed -i 's|# android.permissions = |android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,MANAGE_EXTERNAL_STORAGE,READ_MEDIA_IMAGES,READ_MEDIA_VIDEO|' buildozer.spec
          
          sed -i 's|android.logcat = false|android.logcat = true|' buildozer.spec
          sed -i 's|# android.sdk_path = |android.sdk_path = /home/runner/.buildozer/android/platform/android-sdk|' buildozer.spec
          
          # 入口文件
          sed -i 's|# main.py = main.py|main.py = account_book.py|' buildozer.spec
          sed -i 's|# android.entrypoint = org.kivy.android.PythonActivity|android.entrypoint = org.kivy.android.PythonActivity|' buildozer.spec
          sed -i 's|# app.source.dir = .|app.source.dir = .|' buildozer.spec
          sed -i 's|# app.source.include_exts = py,png,jpg,kv,atlas|app.source.include_exts = py,png,jpg,kv,atlas,ttf|' buildozer.spec
          
          # 日志级别
          sed -i 's|# log_level = 1|log_level = 2|' buildozer.spec
          
          # 关键：禁用gstplayer模块（避免编译错误）
          echo "android.add_jars = " >> buildozer.spec
          echo "android.add_assets = " >> buildozer.spec
          echo "kivy.build_options = disable_gstplayer" >> buildozer.spec
          
          # Android 13+ 特殊配置 - 确保target API为33
          echo "android.target_sdk = 33" >> buildozer.spec
          echo "android.min_sdk = 21" >> buildozer.spec
          
          # 添加Android 13兼容性的Android manifest选项
          echo "android.add_compile_options = --add-opens=java.base/java.lang=MODIFIABLE_METHODS" >> buildozer.spec
          echo "android.add_gradle_repositories = https://maven.google.com" >> buildozer.spec
          
          # 内存优化
          echo "p4a.local_recipes = ./" >> buildozer.spec
          echo "p4a.concurrent_build = 1" >> buildozer.spec
          echo "p4a.javac_args = -J-Xmx4096m" >> buildozer.spec
          echo "p4a.ignore_setup_py = false" >> buildozer.spec

      - name: 构建APK
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ANDROIDNDK="/home/runner/.buildozer/android/platform/android-ndk-r21e"
          export ANDROIDAPI="21"
          export ANDROID_BUILD_TOOLS="30.0.3"
          export PATH=$JAVA_HOME/bin:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3:$PATH
          export JAVA_OPTS="-Xmx4096m -Xms2048m"
          export GRADLE_OPTS="-Xmx4096m -Xms2048m"
          
          echo "✅ 工具验证："
          which java && which javac && which sdkmanager && which aidl
          ls -la $ANDROIDNDK
          
          # 构建APK
          buildozer -v android debug 2>&1 | tee buildozer_full.log
          
          # 检查并重命名APK
          echo "✅ 构建完成，检查APK文件："
          if [ -d "${{ github.workspace }}/bin" ]; then
            ls -la ${{ github.workspace }}/bin/
            if ls ${{ github.workspace }}/bin/*.apk 1> /dev/null 2>&1; then
              mv ${{ github.workspace }}/bin/*.apk ${{ github.workspace }}/bin/accountbook-debug.apk
              echo "✅ APK文件已生成：${{ github.workspace }}/bin/accountbook-debug.apk"
            else
              echo "❌ 未找到APK文件，打印详细日志末尾："
              tail -100 buildozer_full.log
              exit 1
            fi
          else
            echo "❌ bin目录不存在"
            exit 1
          fi

      - name: 上传APK和日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 安卓APK+构建日志
          path: |
            ${{ github.workspace }}/bin/accountbook-debug.apk
            ${{ github.workspace }}/buildozer_full.log
            ${{ github.workspace }}/buildozer.spec
          retention-days: 30
