# .github/workflows/android-build.yml
name: 安卓APK自动打包

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    env:
      BUILDOZER_LOG_LEVEL: 2
      ANDROIDNDK: /home/runner/.buildozer/android/platform/android-ndk-r21e
      ANDROIDSDK: /home/runner/.buildozer/android/platform/android-sdk
      ANDROIDAPI: 21
      ANDROID_BUILD_TOOLS: 30.0.3
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      JAVA_OPTS: "-Xmx4096m -Xms2048m"

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装系统依赖
        run: |
          sudo apt update -y
          sudo apt install -y git zip unzip openjdk-17-jdk python3-pip python3-dev autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev libsqlite3-dev build-essential liblzma-dev libbz2-dev libreadline-dev expect lib32z1-dev lib32stdc++6 libjpeg-dev libltdl-dev
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
          java -version
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV

      - name: 安装Python依赖
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install buildozer==1.5.0 cython==0.29.36 kivy==2.1.0 pyjnius==1.6.1 plyer==2.1.0
          pip3 install git+https://github.com/kivy/python-for-android.git@master

      # 修复第75行核心问题：拆分易出错的文件检查逻辑
      - name: 检查并创建main.py
        run: |
          # 检查主代码语法
          python3 -m py_compile account_book.py || exit 1
          # 自动创建main.py（避免here-doc缩进错误）
          echo '# main.py - 安卓打包入口' > main.py
          echo 'import account_book' >> main.py
          echo 'if __name__ == "__main__":' >> main.py
          echo '    account_book.AdvancedAccountBookApp().run()' >> main.py
          # 验证main.py
          python3 -m py_compile main.py || exit 1

      - name: 下载中文字体
        run: |
          if [ ! -f "simhei.ttf" ]; then
            wget --no-check-certificate https://github.com/adobe-fonts/source-han-sans/raw/release/OTF/SimplifiedChinese/SourceHanSansSC-Regular.otf -O simhei.ttf
          fi

      - name: 配置Android SDK/NDK
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          BUILDOZER_SDK_PATH="/home/runner/.buildozer/android/platform/android-sdk"
          BUILDOZER_NDK_PATH="/home/runner/.buildozer/android/platform/android-ndk-r21e"
          mkdir -p $BUILDOZER_SDK_PATH $BUILDOZER_NDK_PATH
          
          # 下载SDK工具
          wget --no-check-certificate https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip -d tmp_cmdline_tools
          mkdir -p $BUILDOZER_SDK_PATH/cmdline-tools/latest
          cp -r tmp_cmdline_tools/cmdline-tools/* $BUILDOZER_SDK_PATH/cmdline-tools/latest/
          rm -rf tmp_cmdline_tools cmdline-tools.zip
          
          # 下载NDK r21e
          wget --no-check-certificate https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O android-ndk-r21e.zip
          unzip -q android-ndk-r21e.zip -d /home/runner/.buildozer/android/platform/
          rm -f android-ndk-r21e.zip
          
          # 接受许可并安装组件
          export PATH=$BUILDOZER_SDK_PATH/cmdline-tools/latest/bin:$PATH
          echo y | sdkmanager --sdk_root=$BUILDOZER_SDK_PATH --licenses
          echo y | sdkmanager --sdk_root=$BUILDOZER_SDK_PATH "platform-tools" "build-tools;30.0.3" "platforms;android-21"

      - name: 生成buildozer.spec
        run: |
          buildozer init
          # 直接写入配置（避免EOF嵌套错误）
          echo "[app]" > buildozer.spec
          echo "title = 记账本" >> buildozer.spec
          echo "version = 0.1" >> buildozer.spec
          echo "package.name = accountbook" >> buildozer.spec
          echo "package.domain = org.example" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "source.include_exts = py,ttf" >> buildozer.spec
          echo "source.include_files = main.py,account_book.py,simhei.ttf" >> buildozer.spec
          echo "requirements = python3,kivy==2.1.0,pyjnius,plyer" >> buildozer.spec
          echo "android.ndk = 21e" >> buildozer.spec
          echo "android.api = 21" >> buildozer.spec
          echo "android.build_tools = 30.0.3" >> buildozer.spec
          echo "android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE" >> buildozer.spec
          echo "[buildozer]" >> buildozer.spec
          echo "log_level = 2" >> buildozer.spec

      - name: 构建APK
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
          export PATH=$JAVA_HOME/bin:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          buildozer -v android debug 2>&1 | tee buildozer.log
          # 复制APK文件
          mkdir -p bin
          cp .buildozer/android/platform/build/outputs/apk/debug/*.apk bin/accountbook.apk || echo "APK构建失败"

      - name: 上传产物
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 记账本APK
          path: |
            bin/accountbook.apk
            buildozer.log
            buildozer.spec
          retention-days: 30
